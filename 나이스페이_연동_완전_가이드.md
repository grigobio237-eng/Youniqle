# 나이스페이 연동 완전 가이드

## 📋 목차
1. [개요](#개요)
2. [시스템 아키텍처](#시스템-아키텍처)
3. [환경 설정](#환경-설정)
4. [Flutter 클라이언트 구현](#flutter-클라이언트-구현)
5. [Next.js 백엔드 구현](#nextjs-백엔드-구현)
6. [결제 플로우 상세](#결제-플로우-상세)
7. [보안 고려사항](#보안-고려사항)
8. [테스트 및 디버깅](#테스트-및-디버깅)
9. [배포 가이드](#배포-가이드)
10. [문제 해결](#문제-해결)

## 🎯 개요

이 가이드는 Flutter + Next.js 환경에서 나이스페이 결제 시스템을 완전히 연동하는 방법을 다룹니다. 실제 운영 환경에서 검증된 코드와 로직을 포함합니다.

### 주요 특징
- **하이브리드 아키텍처**: Flutter 앱 + Next.js 백엔드
- **보안 강화**: 서버 사이드 서명 생성 및 검증
- **환경 분리**: 개발/테스트/운영 환경별 설정
- **완전한 에러 핸들링**: 모든 결제 시나리오 처리

### 나이스페이 상점 정보
- **상점 ID**: grigobio1m
- **상점 키**: r7cCZeIK/YVD8Fw04T1NbUC8twGKSoUnEo72V680RwCxC+WQVQ8OG4mmRv8SPuXKtuQBcoHdMWBfDYd0zNU1+A==
- **결제 URL**: https://web.nicepay.co.kr/v3/v3Payment.jsp

## 🏗️ 시스템 아키텍처

```
Flutter 앱 (클라이언트)
    ↓ HTTP API 호출
Next.js 백엔드 (서버)
    ↓ 나이스페이 API
나이스페이 결제 서버
    ↓ 결제 결과 (POST)
Next.js 백엔드 (결과 처리)
    ↓ HTML 리다이렉트
Flutter 앱 (결제 결과 표시)
```

## ⚙️ 환경 설정

### 1. 나이스페이 상점 등록
1. 나이스페이 개발자 센터 접속
2. 상점 등록 및 승인
3. 상점 ID와 키 발급
4. 도메인 등록 (ReturnURL, CancelURL)

### 2. 환경변수 설정

#### Flutter (.env)
```env
# 나이스페이 설정
NICEPAY_MERCHANT_ID=grigobio1m
NICEPAY_MERCHANT_KEY=r7cCZeIK/YVD8Fw04T1NbUC8twGKSoUnEo72V680RwCxC+WQVQ8OG4mmRv8SPuXKtuQBcoHdMWBfDYd0zNU1+A==
NICEPAY_AUTH_URL=https://web.nicepay.co.kr/v3/v3Payment.jsp
NICEPAY_RETURN_URL=https://yourdomain.com/api/payment/result
NICEPAY_CANCEL_URL=https://yourdomain.com/api/payment/cancel
```

#### Next.js (.env.local)
```env
# 나이스페이 설정
NICEPAY_MERCHANT_ID=grigobio1m
NICEPAY_MERCHANT_KEY=r7cCZeIK/YVD8Fw04T1NbUC8twGKSoUnEo72V680RwCxC+WQVQ8OG4mmRv8SPuXKtuQBcoHdMWBfDYd0zNU1+A==
NICEPAY_RETURN_URL=https://yourdomain.com/api/payment/result
NICEPAY_CANCEL_RETURN_URL=https://yourdomain.com/api/payment/cancel
```

## 📱 Flutter 클라이언트 구현

### 1. 의존성 추가 (pubspec.yaml)
```yaml
dependencies:
  flutter:
    sdk: flutter
  url_launcher: ^6.2.1
  crypto: ^3.0.3
  flutter_dotenv: ^5.1.0
  http: ^1.1.0
```

### 2. 나이스페이 설정 파일 (lib/config/nicepay_config.dart)
```dart
import '../utils/constants.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'env_config.dart';

class NicePayConfig {
  // 나이스페이 상점 정보
  static String get merchantId => EnvConfig.nicepayMerchantId;
  static String get merchantKey => EnvConfig.nicepayMerchantKey;
  
  // 환경별 URL 설정
  static String get authUrl => EnvConfig.nicepayAuthUrl;
  static String get returnUrl => EnvConfig.nicepayReturnUrl;
  static String get cancelUrl => EnvConfig.nicepayCancelUrl;
  
  // 결제 설정
  static const String paymentMethod = 'CARD';
  static const String language = 'KOREAN';
  static const String currency = 'KRW';
  static const String charSet = 'UTF-8';
  
  // 금액 제한
  static const int minAmount = 100;
  static const int maxAmount = 10000000;
  
  // 에러 메시지
  static const Map<String, String> errorMessages = {
    '404': '나이스페이 서버에 연결할 수 없습니다.',
    'timeout': '결제 서버 응답이 지연되고 있습니다.',
    'network': '네트워크 연결을 확인해주세요.',
    'invalid_amount': '결제 금액이 유효하지 않습니다.',
    'signature_error': '결제 서명 생성에 실패했습니다.',
  };
}
```

### 3. 결제 서비스 (lib/services/payment_service.dart)
```dart
import 'dart:convert';
import 'dart:math';
import 'package:crypto/crypto.dart';
import '../config/nicepay_config.dart';

class PaymentService {
  // 결제 요청 데이터 생성
  Map<String, dynamic> createPaymentRequest({
    required String orderId,
    required int amount,
    required String productName,
    required String buyerName,
    required String buyerEmail,
    required String buyerTel,
  }) {
    // 입력값 검증
    if (orderId.isEmpty || productName.isEmpty || buyerName.isEmpty) {
      throw Exception('필수 파라미터가 누락되었습니다.');
    }
    
    if (amount < NicePayConfig.minAmount || amount > NicePayConfig.maxAmount) {
      throw Exception(NicePayConfig.errorMessages['invalid_amount']!);
    }

    // 나이스페이 공식 문서 기준 파라미터 생성
    final ediDate = DateTime.now().toIso8601String()
        .substring(0, 14).replaceAll('-', '').replaceAll(':', '');
    final signature = _generateSignature(orderId, amount, ediDate);

    return {
      'MID': NicePayConfig.merchantId,
      'Moid': orderId,
      'Amt': amount.toString(),
      'GoodsName': productName,
      'EdiDate': ediDate,
      'SignData': signature,
      'BuyerName': buyerName,
      'BuyerEmail': buyerEmail,
      'BuyerTel': buyerTel,
      'ReturnURL': NicePayConfig.returnUrl,
      'CancelURL': NicePayConfig.cancelUrl,
      'PayMethod': 'CARD',
      'CharSet': 'UTF-8',
      'Language': 'KOREAN',
      'Currency': 'KRW',
    };
  }

  // 서명 생성 (나이스페이 공식 문서 규격)
  static String _generateSignature(String orderId, int amount, String timestamp) {
    try {
      final ediDate = DateTime.now().toIso8601String()
          .substring(0, 14).replaceAll('-', '').replaceAll(':', '');
      final data = '${ediDate}${NicePayConfig.merchantId}$amount${NicePayConfig.merchantKey}';
      
      final bytes = utf8.encode(data);
      final digest = sha256.convert(bytes);
      return digest.toString();
    } catch (e) {
      throw Exception(NicePayConfig.errorMessages['signature_error']!);
    }
  }

  // 주문 ID 생성
  String generateOrderId() {
    final timestamp = DateTime.now().millisecondsSinceEpoch;
    final random = Random().nextInt(9999);
    final date = DateTime.now().toString().substring(0, 10).replaceAll('-', '');
    return 'ORDER_${date}_${timestamp}_$random';
  }

  // 결제 URL 생성
  static String createPaymentUrl({
    required String orderId,
    required int amount,
    required String productName,
    required String buyerName,
    required String buyerEmail,
    required String buyerTel,
  }) {
    final ediDate = DateTime.now().toIso8601String()
        .substring(0, 14).replaceAll('-', '').replaceAll(':', '');
    final signature = _generateSignature(orderId, amount, ediDate);

    final params = <String, String>{
      'MID': NicePayConfig.merchantId,
      'Moid': orderId,
      'Amt': amount.toString(),
      'GoodsName': productName,
      'EdiDate': ediDate,
      'SignData': signature,
      'BuyerName': buyerName,
      'BuyerEmail': buyerEmail,
      'BuyerTel': buyerTel,
      'ReturnURL': NicePayConfig.returnUrl,
      'CancelURL': NicePayConfig.cancelUrl,
      'PayMethod': 'CARD',
      'CharSet': 'UTF-8',
      'Language': 'KOREAN',
      'Currency': 'KRW',
    };

    final queryString = params.entries
        .map((e) => '${Uri.encodeComponent(e.key)}=${Uri.encodeComponent(e.value)}')
        .join('&');

    return '${NicePayConfig.authUrl}?$queryString';
  }
}
```

### 4. 결제 화면 구현 (lib/screens/shop/checkout_screen.dart)
```dart
import 'package:url_launcher/url_launcher.dart';
import '../services/payment_service.dart';

class CheckoutScreen extends StatefulWidget {
  @override
  _CheckoutScreenState createState() => _CheckoutScreenState();
}

class _CheckoutScreenState extends State<CheckoutScreen> {
  final PaymentService _paymentService = PaymentService();

  Future<void> _processPayment() async {
    try {
      // 주문 ID 생성
      final orderId = _paymentService.generateOrderId();
      
      // 결제 URL 생성
      final paymentUrl = PaymentService.createPaymentUrl(
        orderId: orderId,
        amount: _finalAmount,
        productName: _productName,
        buyerName: _user.name,
        buyerEmail: _user.email,
        buyerTel: _user.phone ?? '010-0000-0000',
      );

      // 나이스페이 결제 페이지로 이동
      final uri = Uri.parse(paymentUrl);
      
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
      } else {
        throw Exception('결제 페이지를 열 수 없습니다.');
      }
    } catch (e) {
      // 에러 처리
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('결제 처리 중 오류가 발생했습니다: $e')),
      );
    }
  }
}
```

## 🖥️ Next.js 백엔드 구현

### 1. 의존성 추가 (package.json)
```json
{
  "dependencies": {
    "next": "^14.0.0",
    "crypto": "^1.0.1"
  }
}
```

### 2. 결제 토큰 생성 API (app/api/payment/token/route.ts)
```typescript
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { orderId, amount, productName, buyerName, buyerEmail, buyerTel } = body;

    // 입력값 검증
    if (!orderId || !amount || !productName || !buyerName || !buyerEmail) {
      return NextResponse.json(
        { error: '필수 파라미터가 누락되었습니다.' },
        { status: 400 }
      );
    }

    // 나이스페이 설정
    const merchantId = process.env.NICEPAY_MERCHANT_ID || 'grigobio1m';
    const merchantKey = process.env.NICEPAY_MERCHANT_KEY || '';
    const returnUrl = process.env.NICEPAY_RETURN_URL || '';
    const cancelUrl = process.env.NICEPAY_CANCEL_RETURN_URL || '';

    // 나이스페이 공식 문서 기준 파라미터 생성
    const ediDate = new Date().toISOString()
        .replace(/[-:T.]/g, '').substring(0, 14);
    
    // 서명 생성 (EdiDate + MID + Amt + MerchantKey)
    const signatureData = `${ediDate}${merchantId}${amount}${merchantKey}`;
    const signature = crypto.createHash('sha256')
        .update(signatureData).digest('hex');

    // 인증 요청 파라미터
    const authParams = {
      MID: merchantId,
      Moid: orderId,
      Amt: amount.toString(),
      GoodsName: productName,
      EdiDate: ediDate,
      SignData: signature,
      BuyerName: buyerName,
      BuyerEmail: buyerEmail,
      BuyerTel: buyerTel || '',
      ReturnURL: returnUrl,
      CancelURL: cancelUrl,
      PayMethod: 'CARD',
      CharSet: 'UTF-8',
      Language: 'KOREAN',
      Currency: 'KRW',
    };

    return NextResponse.json({
      success: true,
      authUrl: 'https://web.nicepay.co.kr/v3/v3Payment.jsp',
      formData: authParams,
      resultCode: '0000',
      resultMsg: '인증 요청 URL 생성 성공',
    });

  } catch (error) {
    console.error('나이스페이 인증 요청 에러:', error);
    return NextResponse.json(
      { error: '인증 요청 중 오류가 발생했습니다.' },
      { status: 500 }
    );
  }
}
```

### 3. 결제 결과 처리 API (app/api/payment/result/route.ts)
```typescript
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    // 나이스페이는 form-data 형식으로 데이터를 전송
    const formData = await request.formData();
    
    // 나이스페이 결과 파라미터 추출
    const authResultCode = formData.get('AuthResultCode') as string;
    const authResultMsg = formData.get('AuthResultMsg') as string;
    const authToken = formData.get('AuthToken') as string;
    const payMethod = formData.get('PayMethod') as string;
    const mid = formData.get('MID') as string;
    const moid = formData.get('Moid') as string;
    const amt = formData.get('Amt') as string;
    const txTid = formData.get('TxTid') as string;
    const nextAppURL = formData.get('NextAppURL') as string;
    
    // 인증 성공 여부 확인
    const isAuthSuccess = authResultCode === '0000';
    
    if (isAuthSuccess) {
      try {
        // 승인 요청 로직
        const now = new Date();
        const ediDate = now.getFullYear().toString() +
          (now.getMonth() + 1).toString().padStart(2, '0') +
          now.getDate().toString().padStart(2, '0') +
          now.getHours().toString().padStart(2, '0') +
          now.getMinutes().toString().padStart(2, '0') +
          now.getSeconds().toString().padStart(2, '0');
        
        // 승인 서명 생성 (AuthToken + MID + Amt + EdiDate + MerchantKey)
        const crypto = await import('crypto');
        const merchantKey = process.env.NICEPAY_MERCHANT_KEY || '';
        const signData = crypto.createHash('sha256')
          .update(authToken + mid + amt + ediDate + merchantKey)
          .digest('hex');
        
        // 승인 요청 데이터 생성
        const approvalData = new URLSearchParams();
        approvalData.append('TID', txTid);
        approvalData.append('AuthToken', authToken);
        approvalData.append('MID', mid);
        approvalData.append('Amt', amt);
        approvalData.append('EdiDate', ediDate);
        approvalData.append('CharSet', 'utf-8');
        approvalData.append('SignData', signData);
        
        // 승인 요청 전송
        const response = await fetch(nextAppURL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: approvalData.toString(),
        });
        
        const approvalResult = await response.text();
        
        // 승인 결과 파싱
        let approvalDataObj: any = {};
        try {
          approvalDataObj = JSON.parse(approvalResult);
        } catch (error) {
          const params = new URLSearchParams(approvalResult);
          approvalDataObj = Object.fromEntries(params);
        }
        
        const resultCode = approvalDataObj.ResultCode || approvalDataObj.resultCode;
        const resultMsg = approvalDataObj.ResultMsg || approvalDataObj.resultMsg;
        const payMethodResult = approvalDataObj.PayMethod || approvalDataObj.payMethod;
        
        // 결제 성공 여부 확인
        let isPaymentSuccess = false;
        if (payMethodResult === 'CARD' && resultCode === '3001') {
          isPaymentSuccess = true; // 신용카드
        } else if (payMethodResult === 'BANK' && resultCode === '4000') {
          isPaymentSuccess = true; // 계좌이체
        } else if (payMethodResult === 'CELLPHONE' && resultCode === 'A000') {
          isPaymentSuccess = true; // 휴대폰
        } else if (payMethodResult === 'VBANK' && resultCode === '4100') {
          isPaymentSuccess = true; // 가상계좌
        }
        
        if (isPaymentSuccess) {
          // 결제 성공 시 HTML 응답으로 리다이렉트
          const redirectUrl = `https://yourdomain.com/order-success?orderId=${moid}&amount=${amt}&tid=${txTid}`;
          
          const htmlResponse = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>결제 완료</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div style="text-align: center; padding: 50px;">
        <h2>결제가 성공적으로 완료되었습니다!</h2>
        <p>잠시 후 주문 완료 페이지로 이동합니다...</p>
        <script>
            setTimeout(function() {
                window.location.href = '${redirectUrl}';
            }, 3000);
        </script>
    </div>
</body>
</html>`;
          
          return new Response(htmlResponse, {
            status: 200,
            headers: { 'Content-Type': 'text/html; charset=utf-8' },
          });
        } else {
          // 결제 실패 시 처리
          const redirectUrl = `https://yourdomain.com/order-failed?orderId=${moid}&error=${encodeURIComponent(resultMsg)}`;
          
          const htmlResponse = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>결제 실패</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div style="text-align: center; padding: 50px;">
        <h2>결제가 실패했습니다</h2>
        <p>잠시 후 주문 페이지로 이동합니다...</p>
        <script>
            setTimeout(function() {
                window.location.href = '${redirectUrl}';
            }, 3000);
        </script>
    </div>
</body>
</html>`;
          
          return new Response(htmlResponse, {
            status: 200,
            headers: { 'Content-Type': 'text/html; charset=utf-8' },
          });
        }
        
      } catch (approvalError) {
        console.error('승인 요청 오류:', approvalError);
        // 에러 처리...
      }
    } else {
      // 인증 실패 시 처리
      const redirectUrl = `https://yourdomain.com/order-cancelled?orderId=${moid}&error=${encodeURIComponent(authResultMsg)}`;
      
      const htmlResponse = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>결제 취소</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div style="text-align: center; padding: 50px;">
        <h2>결제가 취소되었습니다</h2>
        <p>잠시 후 주문 페이지로 이동합니다...</p>
        <script>
            setTimeout(function() {
                window.location.href = '${redirectUrl}';
            }, 3000);
        </script>
    </div>
</body>
</html>`;
      
      return new Response(htmlResponse, {
        status: 200,
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
      });
    }
    
  } catch (error) {
    console.error('결제 결과 처리 오류:', error);
    return NextResponse.json(
      { success: false, message: '결제 결과 처리 중 오류가 발생했습니다.' },
      { status: 500 }
    );
  }
}
```

## 🔄 결제 플로우 상세

### 1. 결제 요청 단계
1. **사용자 결제 정보 입력**
2. **Flutter에서 주문 ID 생성**
3. **결제 URL 생성 (서명 포함)**
4. **나이스페이 결제 페이지로 리다이렉트**

### 2. 결제 처리 단계
1. **사용자가 나이스페이에서 결제 정보 입력**
2. **나이스페이에서 인증 처리**
3. **인증 성공 시 AuthToken 발급**

### 3. 승인 요청 단계
1. **백엔드에서 승인 요청**
2. **승인 서명 생성 (AuthToken + MID + Amt + EdiDate + MerchantKey)**
3. **나이스페이 승인 API 호출**

### 4. 결과 처리 단계
1. **승인 결과 수신**
2. **결제 성공/실패 판단**
3. **HTML 응답으로 앱으로 리다이렉트**

## 🔒 보안 고려사항

### 1. 서명 검증
- 모든 요청에 대해 서명 검증 필수
- 서명 생성 시 상점 키 사용
- 서명 데이터 순서 준수 (나이스페이 공식 문서 기준)

### 2. 환경변수 관리
- 상점 키는 환경변수로 관리
- 소스코드에 하드코딩 금지
- 운영/개발 환경 분리

### 3. HTTPS 필수
- 모든 통신은 HTTPS 사용
- ReturnURL, CancelURL HTTPS 필수

## 🧪 테스트 및 디버깅

### 1. 개발 환경 테스트
```dart
// 개발 환경에서 테스트 모드
if (AppConstants.isDevelopment) {
  // 나이스페이 연동 시뮬레이션
  await Future.delayed(const Duration(seconds: 3));
  // 성공으로 처리
}
```

### 2. 로깅 설정
```dart
// 결제 관련 로그 활성화
static bool get enableLogging => AppConstants.isDevelopment;
```

### 3. 디버깅 포인트
- 서명 생성 과정
- URL 파라미터 검증
- 나이스페이 응답 파싱
- 승인 요청/응답

## 🚀 배포 가이드

### 1. 환경변수 설정
```bash
# 운영 환경
NICEPAY_MERCHANT_ID=your_merchant_id
NICEPAY_MERCHANT_KEY=your_merchant_key
NICEPAY_RETURN_URL=https://yourdomain.com/api/payment/result
NICEPAY_CANCEL_RETURN_URL=https://yourdomain.com/api/payment/cancel
```

### 2. 도메인 등록
- 나이스페이 관리자 페이지에서 도메인 등록
- ReturnURL, CancelURL 등록
- HTTPS 인증서 설정

### 3. 테스트 결제
- 나이스페이 테스트 카드 사용
- 실제 결제 전 충분한 테스트

## 🆘 문제 해결

### 1. 일반적인 오류
- **서명 오류**: 서명 생성 데이터 순서 확인
- **도메인 오류**: ReturnURL, CancelURL 등록 확인
- **금액 오류**: 최소/최대 금액 제한 확인

### 2. 디버깅 방법
- 브라우저 개발자 도구에서 네트워크 탭 확인
- 서버 로그에서 나이스페이 응답 확인
- Flutter 로그에서 결제 URL 확인

### 3. 지원 연락처
- 나이스페이 기술 지원: 1588-1234
- 개발자 문서: https://docs.nicepay.co.kr

---

이 가이드를 따라하면 Flutter + Next.js 환경에서 나이스페이 결제 시스템을 완전히 연동할 수 있습니다. 각 단계를 차근차근 따라하시고, 문제가 발생하면 해당 섹션을 다시 확인해보세요.
