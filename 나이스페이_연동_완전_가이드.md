# ë‚˜ì´ìŠ¤í˜ì´ ì—°ë™ ì™„ì „ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
3. [í™˜ê²½ ì„¤ì •](#í™˜ê²½-ì„¤ì •)
4. [Flutter í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„](#flutter-í´ë¼ì´ì–¸íŠ¸-êµ¬í˜„)
5. [Next.js ë°±ì—”ë“œ êµ¬í˜„](#nextjs-ë°±ì—”ë“œ-êµ¬í˜„)
6. [ê²°ì œ í”Œë¡œìš° ìƒì„¸](#ê²°ì œ-í”Œë¡œìš°-ìƒì„¸)
7. [ë³´ì•ˆ ê³ ë ¤ì‚¬í•­](#ë³´ì•ˆ-ê³ ë ¤ì‚¬í•­)
8. [í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹…](#í…ŒìŠ¤íŠ¸-ë°-ë””ë²„ê¹…)
9. [ë°°í¬ ê°€ì´ë“œ](#ë°°í¬-ê°€ì´ë“œ)
10. [ë¬¸ì œ í•´ê²°](#ë¬¸ì œ-í•´ê²°)

## ğŸ¯ ê°œìš”

ì´ ê°€ì´ë“œëŠ” Flutter + Next.js í™˜ê²½ì—ì„œ ë‚˜ì´ìŠ¤í˜ì´ ê²°ì œ ì‹œìŠ¤í…œì„ ì™„ì „íˆ ì—°ë™í•˜ëŠ” ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œ ê²€ì¦ëœ ì½”ë“œì™€ ë¡œì§ì„ í¬í•¨í•©ë‹ˆë‹¤.

### ì£¼ìš” íŠ¹ì§•
- **í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜**: Flutter ì•± + Next.js ë°±ì—”ë“œ
- **ë³´ì•ˆ ê°•í™”**: ì„œë²„ ì‚¬ì´ë“œ ì„œëª… ìƒì„± ë° ê²€ì¦
- **í™˜ê²½ ë¶„ë¦¬**: ê°œë°œ/í…ŒìŠ¤íŠ¸/ìš´ì˜ í™˜ê²½ë³„ ì„¤ì •
- **ì™„ì „í•œ ì—ëŸ¬ í•¸ë“¤ë§**: ëª¨ë“  ê²°ì œ ì‹œë‚˜ë¦¬ì˜¤ ì²˜ë¦¬

### ë‚˜ì´ìŠ¤í˜ì´ ìƒì  ì •ë³´
- **ìƒì  ID**: grigobio1m
- **ìƒì  í‚¤**: r7cCZeIK/YVD8Fw04T1NbUC8twGKSoUnEo72V680RwCxC+WQVQ8OG4mmRv8SPuXKtuQBcoHdMWBfDYd0zNU1+A==
- **ê²°ì œ URL**: https://web.nicepay.co.kr/v3/v3Payment.jsp

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
Flutter ì•± (í´ë¼ì´ì–¸íŠ¸)
    â†“ HTTP API í˜¸ì¶œ
Next.js ë°±ì—”ë“œ (ì„œë²„)
    â†“ ë‚˜ì´ìŠ¤í˜ì´ API
ë‚˜ì´ìŠ¤í˜ì´ ê²°ì œ ì„œë²„
    â†“ ê²°ì œ ê²°ê³¼ (POST)
Next.js ë°±ì—”ë“œ (ê²°ê³¼ ì²˜ë¦¬)
    â†“ HTML ë¦¬ë‹¤ì´ë ‰íŠ¸
Flutter ì•± (ê²°ì œ ê²°ê³¼ í‘œì‹œ)
```

## âš™ï¸ í™˜ê²½ ì„¤ì •

### 1. ë‚˜ì´ìŠ¤í˜ì´ ìƒì  ë“±ë¡
1. ë‚˜ì´ìŠ¤í˜ì´ ê°œë°œì ì„¼í„° ì ‘ì†
2. ìƒì  ë“±ë¡ ë° ìŠ¹ì¸
3. ìƒì  IDì™€ í‚¤ ë°œê¸‰
4. ë„ë©”ì¸ ë“±ë¡ (ReturnURL, CancelURL)

### 2. í™˜ê²½ë³€ìˆ˜ ì„¤ì •

#### Flutter (.env)
```env
# ë‚˜ì´ìŠ¤í˜ì´ ì„¤ì •
NICEPAY_MERCHANT_ID=grigobio1m
NICEPAY_MERCHANT_KEY=r7cCZeIK/YVD8Fw04T1NbUC8twGKSoUnEo72V680RwCxC+WQVQ8OG4mmRv8SPuXKtuQBcoHdMWBfDYd0zNU1+A==
NICEPAY_AUTH_URL=https://web.nicepay.co.kr/v3/v3Payment.jsp
NICEPAY_RETURN_URL=https://yourdomain.com/api/payment/result
NICEPAY_CANCEL_URL=https://yourdomain.com/api/payment/cancel
```

#### Next.js (.env.local)
```env
# ë‚˜ì´ìŠ¤í˜ì´ ì„¤ì •
NICEPAY_MERCHANT_ID=grigobio1m
NICEPAY_MERCHANT_KEY=r7cCZeIK/YVD8Fw04T1NbUC8twGKSoUnEo72V680RwCxC+WQVQ8OG4mmRv8SPuXKtuQBcoHdMWBfDYd0zNU1+A==
NICEPAY_RETURN_URL=https://yourdomain.com/api/payment/result
NICEPAY_CANCEL_RETURN_URL=https://yourdomain.com/api/payment/cancel
```

## ğŸ“± Flutter í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„

### 1. ì˜ì¡´ì„± ì¶”ê°€ (pubspec.yaml)
```yaml
dependencies:
  flutter:
    sdk: flutter
  url_launcher: ^6.2.1
  crypto: ^3.0.3
  flutter_dotenv: ^5.1.0
  http: ^1.1.0
```

### 2. ë‚˜ì´ìŠ¤í˜ì´ ì„¤ì • íŒŒì¼ (lib/config/nicepay_config.dart)
```dart
import '../utils/constants.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'env_config.dart';

class NicePayConfig {
  // ë‚˜ì´ìŠ¤í˜ì´ ìƒì  ì •ë³´
  static String get merchantId => EnvConfig.nicepayMerchantId;
  static String get merchantKey => EnvConfig.nicepayMerchantKey;
  
  // í™˜ê²½ë³„ URL ì„¤ì •
  static String get authUrl => EnvConfig.nicepayAuthUrl;
  static String get returnUrl => EnvConfig.nicepayReturnUrl;
  static String get cancelUrl => EnvConfig.nicepayCancelUrl;
  
  // ê²°ì œ ì„¤ì •
  static const String paymentMethod = 'CARD';
  static const String language = 'KOREAN';
  static const String currency = 'KRW';
  static const String charSet = 'UTF-8';
  
  // ê¸ˆì•¡ ì œí•œ
  static const int minAmount = 100;
  static const int maxAmount = 10000000;
  
  // ì—ëŸ¬ ë©”ì‹œì§€
  static const Map<String, String> errorMessages = {
    '404': 'ë‚˜ì´ìŠ¤í˜ì´ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
    'timeout': 'ê²°ì œ ì„œë²„ ì‘ë‹µì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.',
    'network': 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
    'invalid_amount': 'ê²°ì œ ê¸ˆì•¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    'signature_error': 'ê²°ì œ ì„œëª… ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
  };
}
```

### 3. ê²°ì œ ì„œë¹„ìŠ¤ (lib/services/payment_service.dart)
```dart
import 'dart:convert';
import 'dart:math';
import 'package:crypto/crypto.dart';
import '../config/nicepay_config.dart';

class PaymentService {
  // ê²°ì œ ìš”ì²­ ë°ì´í„° ìƒì„±
  Map<String, dynamic> createPaymentRequest({
    required String orderId,
    required int amount,
    required String productName,
    required String buyerName,
    required String buyerEmail,
    required String buyerTel,
  }) {
    // ì…ë ¥ê°’ ê²€ì¦
    if (orderId.isEmpty || productName.isEmpty || buyerName.isEmpty) {
      throw Exception('í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    if (amount < NicePayConfig.minAmount || amount > NicePayConfig.maxAmount) {
      throw Exception(NicePayConfig.errorMessages['invalid_amount']!);
    }

    // ë‚˜ì´ìŠ¤í˜ì´ ê³µì‹ ë¬¸ì„œ ê¸°ì¤€ íŒŒë¼ë¯¸í„° ìƒì„±
    final ediDate = DateTime.now().toIso8601String()
        .substring(0, 14).replaceAll('-', '').replaceAll(':', '');
    final signature = _generateSignature(orderId, amount, ediDate);

    return {
      'MID': NicePayConfig.merchantId,
      'Moid': orderId,
      'Amt': amount.toString(),
      'GoodsName': productName,
      'EdiDate': ediDate,
      'SignData': signature,
      'BuyerName': buyerName,
      'BuyerEmail': buyerEmail,
      'BuyerTel': buyerTel,
      'ReturnURL': NicePayConfig.returnUrl,
      'CancelURL': NicePayConfig.cancelUrl,
      'PayMethod': 'CARD',
      'CharSet': 'UTF-8',
      'Language': 'KOREAN',
      'Currency': 'KRW',
    };
  }

  // ì„œëª… ìƒì„± (ë‚˜ì´ìŠ¤í˜ì´ ê³µì‹ ë¬¸ì„œ ê·œê²©)
  static String _generateSignature(String orderId, int amount, String timestamp) {
    try {
      final ediDate = DateTime.now().toIso8601String()
          .substring(0, 14).replaceAll('-', '').replaceAll(':', '');
      final data = '${ediDate}${NicePayConfig.merchantId}$amount${NicePayConfig.merchantKey}';
      
      final bytes = utf8.encode(data);
      final digest = sha256.convert(bytes);
      return digest.toString();
    } catch (e) {
      throw Exception(NicePayConfig.errorMessages['signature_error']!);
    }
  }

  // ì£¼ë¬¸ ID ìƒì„±
  String generateOrderId() {
    final timestamp = DateTime.now().millisecondsSinceEpoch;
    final random = Random().nextInt(9999);
    final date = DateTime.now().toString().substring(0, 10).replaceAll('-', '');
    return 'ORDER_${date}_${timestamp}_$random';
  }

  // ê²°ì œ URL ìƒì„±
  static String createPaymentUrl({
    required String orderId,
    required int amount,
    required String productName,
    required String buyerName,
    required String buyerEmail,
    required String buyerTel,
  }) {
    final ediDate = DateTime.now().toIso8601String()
        .substring(0, 14).replaceAll('-', '').replaceAll(':', '');
    final signature = _generateSignature(orderId, amount, ediDate);

    final params = <String, String>{
      'MID': NicePayConfig.merchantId,
      'Moid': orderId,
      'Amt': amount.toString(),
      'GoodsName': productName,
      'EdiDate': ediDate,
      'SignData': signature,
      'BuyerName': buyerName,
      'BuyerEmail': buyerEmail,
      'BuyerTel': buyerTel,
      'ReturnURL': NicePayConfig.returnUrl,
      'CancelURL': NicePayConfig.cancelUrl,
      'PayMethod': 'CARD',
      'CharSet': 'UTF-8',
      'Language': 'KOREAN',
      'Currency': 'KRW',
    };

    final queryString = params.entries
        .map((e) => '${Uri.encodeComponent(e.key)}=${Uri.encodeComponent(e.value)}')
        .join('&');

    return '${NicePayConfig.authUrl}?$queryString';
  }
}
```

### 4. ê²°ì œ í™”ë©´ êµ¬í˜„ (lib/screens/shop/checkout_screen.dart)
```dart
import 'package:url_launcher/url_launcher.dart';
import '../services/payment_service.dart';

class CheckoutScreen extends StatefulWidget {
  @override
  _CheckoutScreenState createState() => _CheckoutScreenState();
}

class _CheckoutScreenState extends State<CheckoutScreen> {
  final PaymentService _paymentService = PaymentService();

  Future<void> _processPayment() async {
    try {
      // ì£¼ë¬¸ ID ìƒì„±
      final orderId = _paymentService.generateOrderId();
      
      // ê²°ì œ URL ìƒì„±
      final paymentUrl = PaymentService.createPaymentUrl(
        orderId: orderId,
        amount: _finalAmount,
        productName: _productName,
        buyerName: _user.name,
        buyerEmail: _user.email,
        buyerTel: _user.phone ?? '010-0000-0000',
      );

      // ë‚˜ì´ìŠ¤í˜ì´ ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
      final uri = Uri.parse(paymentUrl);
      
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
      } else {
        throw Exception('ê²°ì œ í˜ì´ì§€ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    } catch (e) {
      // ì—ëŸ¬ ì²˜ë¦¬
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $e')),
      );
    }
  }
}
```

## ğŸ–¥ï¸ Next.js ë°±ì—”ë“œ êµ¬í˜„

### 1. ì˜ì¡´ì„± ì¶”ê°€ (package.json)
```json
{
  "dependencies": {
    "next": "^14.0.0",
    "crypto": "^1.0.1"
  }
}
```

### 2. ê²°ì œ í† í° ìƒì„± API (app/api/payment/token/route.ts)
```typescript
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { orderId, amount, productName, buyerName, buyerEmail, buyerTel } = body;

    // ì…ë ¥ê°’ ê²€ì¦
    if (!orderId || !amount || !productName || !buyerName || !buyerEmail) {
      return NextResponse.json(
        { error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // ë‚˜ì´ìŠ¤í˜ì´ ì„¤ì •
    const merchantId = process.env.NICEPAY_MERCHANT_ID || 'grigobio1m';
    const merchantKey = process.env.NICEPAY_MERCHANT_KEY || '';
    const returnUrl = process.env.NICEPAY_RETURN_URL || '';
    const cancelUrl = process.env.NICEPAY_CANCEL_RETURN_URL || '';

    // ë‚˜ì´ìŠ¤í˜ì´ ê³µì‹ ë¬¸ì„œ ê¸°ì¤€ íŒŒë¼ë¯¸í„° ìƒì„±
    const ediDate = new Date().toISOString()
        .replace(/[-:T.]/g, '').substring(0, 14);
    
    // ì„œëª… ìƒì„± (EdiDate + MID + Amt + MerchantKey)
    const signatureData = `${ediDate}${merchantId}${amount}${merchantKey}`;
    const signature = crypto.createHash('sha256')
        .update(signatureData).digest('hex');

    // ì¸ì¦ ìš”ì²­ íŒŒë¼ë¯¸í„°
    const authParams = {
      MID: merchantId,
      Moid: orderId,
      Amt: amount.toString(),
      GoodsName: productName,
      EdiDate: ediDate,
      SignData: signature,
      BuyerName: buyerName,
      BuyerEmail: buyerEmail,
      BuyerTel: buyerTel || '',
      ReturnURL: returnUrl,
      CancelURL: cancelUrl,
      PayMethod: 'CARD',
      CharSet: 'UTF-8',
      Language: 'KOREAN',
      Currency: 'KRW',
    };

    return NextResponse.json({
      success: true,
      authUrl: 'https://web.nicepay.co.kr/v3/v3Payment.jsp',
      formData: authParams,
      resultCode: '0000',
      resultMsg: 'ì¸ì¦ ìš”ì²­ URL ìƒì„± ì„±ê³µ',
    });

  } catch (error) {
    console.error('ë‚˜ì´ìŠ¤í˜ì´ ì¸ì¦ ìš”ì²­ ì—ëŸ¬:', error);
    return NextResponse.json(
      { error: 'ì¸ì¦ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}
```

### 3. ê²°ì œ ê²°ê³¼ ì²˜ë¦¬ API (app/api/payment/result/route.ts)
```typescript
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    // ë‚˜ì´ìŠ¤í˜ì´ëŠ” form-data í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡
    const formData = await request.formData();
    
    // ë‚˜ì´ìŠ¤í˜ì´ ê²°ê³¼ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
    const authResultCode = formData.get('AuthResultCode') as string;
    const authResultMsg = formData.get('AuthResultMsg') as string;
    const authToken = formData.get('AuthToken') as string;
    const payMethod = formData.get('PayMethod') as string;
    const mid = formData.get('MID') as string;
    const moid = formData.get('Moid') as string;
    const amt = formData.get('Amt') as string;
    const txTid = formData.get('TxTid') as string;
    const nextAppURL = formData.get('NextAppURL') as string;
    
    // ì¸ì¦ ì„±ê³µ ì—¬ë¶€ í™•ì¸
    const isAuthSuccess = authResultCode === '0000';
    
    if (isAuthSuccess) {
      try {
        // ìŠ¹ì¸ ìš”ì²­ ë¡œì§
        const now = new Date();
        const ediDate = now.getFullYear().toString() +
          (now.getMonth() + 1).toString().padStart(2, '0') +
          now.getDate().toString().padStart(2, '0') +
          now.getHours().toString().padStart(2, '0') +
          now.getMinutes().toString().padStart(2, '0') +
          now.getSeconds().toString().padStart(2, '0');
        
        // ìŠ¹ì¸ ì„œëª… ìƒì„± (AuthToken + MID + Amt + EdiDate + MerchantKey)
        const crypto = await import('crypto');
        const merchantKey = process.env.NICEPAY_MERCHANT_KEY || '';
        const signData = crypto.createHash('sha256')
          .update(authToken + mid + amt + ediDate + merchantKey)
          .digest('hex');
        
        // ìŠ¹ì¸ ìš”ì²­ ë°ì´í„° ìƒì„±
        const approvalData = new URLSearchParams();
        approvalData.append('TID', txTid);
        approvalData.append('AuthToken', authToken);
        approvalData.append('MID', mid);
        approvalData.append('Amt', amt);
        approvalData.append('EdiDate', ediDate);
        approvalData.append('CharSet', 'utf-8');
        approvalData.append('SignData', signData);
        
        // ìŠ¹ì¸ ìš”ì²­ ì „ì†¡
        const response = await fetch(nextAppURL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: approvalData.toString(),
        });
        
        const approvalResult = await response.text();
        
        // ìŠ¹ì¸ ê²°ê³¼ íŒŒì‹±
        let approvalDataObj: any = {};
        try {
          approvalDataObj = JSON.parse(approvalResult);
        } catch (error) {
          const params = new URLSearchParams(approvalResult);
          approvalDataObj = Object.fromEntries(params);
        }
        
        const resultCode = approvalDataObj.ResultCode || approvalDataObj.resultCode;
        const resultMsg = approvalDataObj.ResultMsg || approvalDataObj.resultMsg;
        const payMethodResult = approvalDataObj.PayMethod || approvalDataObj.payMethod;
        
        // ê²°ì œ ì„±ê³µ ì—¬ë¶€ í™•ì¸
        let isPaymentSuccess = false;
        if (payMethodResult === 'CARD' && resultCode === '3001') {
          isPaymentSuccess = true; // ì‹ ìš©ì¹´ë“œ
        } else if (payMethodResult === 'BANK' && resultCode === '4000') {
          isPaymentSuccess = true; // ê³„ì¢Œì´ì²´
        } else if (payMethodResult === 'CELLPHONE' && resultCode === 'A000') {
          isPaymentSuccess = true; // íœ´ëŒ€í°
        } else if (payMethodResult === 'VBANK' && resultCode === '4100') {
          isPaymentSuccess = true; // ê°€ìƒê³„ì¢Œ
        }
        
        if (isPaymentSuccess) {
          // ê²°ì œ ì„±ê³µ ì‹œ HTML ì‘ë‹µìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          const redirectUrl = `https://yourdomain.com/order-success?orderId=${moid}&amount=${amt}&tid=${txTid}`;
          
          const htmlResponse = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ê²°ì œ ì™„ë£Œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div style="text-align: center; padding: 50px;">
        <h2>ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
        <p>ì ì‹œ í›„ ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
        <script>
            setTimeout(function() {
                window.location.href = '${redirectUrl}';
            }, 3000);
        </script>
    </div>
</body>
</html>`;
          
          return new Response(htmlResponse, {
            status: 200,
            headers: { 'Content-Type': 'text/html; charset=utf-8' },
          });
        } else {
          // ê²°ì œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
          const redirectUrl = `https://yourdomain.com/order-failed?orderId=${moid}&error=${encodeURIComponent(resultMsg)}`;
          
          const htmlResponse = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ê²°ì œ ì‹¤íŒ¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div style="text-align: center; padding: 50px;">
        <h2>ê²°ì œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</h2>
        <p>ì ì‹œ í›„ ì£¼ë¬¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
        <script>
            setTimeout(function() {
                window.location.href = '${redirectUrl}';
            }, 3000);
        </script>
    </div>
</body>
</html>`;
          
          return new Response(htmlResponse, {
            status: 200,
            headers: { 'Content-Type': 'text/html; charset=utf-8' },
          });
        }
        
      } catch (approvalError) {
        console.error('ìŠ¹ì¸ ìš”ì²­ ì˜¤ë¥˜:', approvalError);
        // ì—ëŸ¬ ì²˜ë¦¬...
      }
    } else {
      // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
      const redirectUrl = `https://yourdomain.com/order-cancelled?orderId=${moid}&error=${encodeURIComponent(authResultMsg)}`;
      
      const htmlResponse = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ê²°ì œ ì·¨ì†Œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div style="text-align: center; padding: 50px;">
        <h2>ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
        <p>ì ì‹œ í›„ ì£¼ë¬¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
        <script>
            setTimeout(function() {
                window.location.href = '${redirectUrl}';
            }, 3000);
        </script>
    </div>
</body>
</html>`;
      
      return new Response(htmlResponse, {
        status: 200,
        headers: { 'Content-Type': 'text/html; charset=utf-8' },
      });
    }
    
  } catch (error) {
    console.error('ê²°ì œ ê²°ê³¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return NextResponse.json(
      { success: false, message: 'ê²°ì œ ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}
```

## ğŸ”„ ê²°ì œ í”Œë¡œìš° ìƒì„¸

### 1. ê²°ì œ ìš”ì²­ ë‹¨ê³„
1. **ì‚¬ìš©ì ê²°ì œ ì •ë³´ ì…ë ¥**
2. **Flutterì—ì„œ ì£¼ë¬¸ ID ìƒì„±**
3. **ê²°ì œ URL ìƒì„± (ì„œëª… í¬í•¨)**
4. **ë‚˜ì´ìŠ¤í˜ì´ ê²°ì œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸**

### 2. ê²°ì œ ì²˜ë¦¬ ë‹¨ê³„
1. **ì‚¬ìš©ìê°€ ë‚˜ì´ìŠ¤í˜ì´ì—ì„œ ê²°ì œ ì •ë³´ ì…ë ¥**
2. **ë‚˜ì´ìŠ¤í˜ì´ì—ì„œ ì¸ì¦ ì²˜ë¦¬**
3. **ì¸ì¦ ì„±ê³µ ì‹œ AuthToken ë°œê¸‰**

### 3. ìŠ¹ì¸ ìš”ì²­ ë‹¨ê³„
1. **ë°±ì—”ë“œì—ì„œ ìŠ¹ì¸ ìš”ì²­**
2. **ìŠ¹ì¸ ì„œëª… ìƒì„± (AuthToken + MID + Amt + EdiDate + MerchantKey)**
3. **ë‚˜ì´ìŠ¤í˜ì´ ìŠ¹ì¸ API í˜¸ì¶œ**

### 4. ê²°ê³¼ ì²˜ë¦¬ ë‹¨ê³„
1. **ìŠ¹ì¸ ê²°ê³¼ ìˆ˜ì‹ **
2. **ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ íŒë‹¨**
3. **HTML ì‘ë‹µìœ¼ë¡œ ì•±ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸**

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. ì„œëª… ê²€ì¦
- ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì„œëª… ê²€ì¦ í•„ìˆ˜
- ì„œëª… ìƒì„± ì‹œ ìƒì  í‚¤ ì‚¬ìš©
- ì„œëª… ë°ì´í„° ìˆœì„œ ì¤€ìˆ˜ (ë‚˜ì´ìŠ¤í˜ì´ ê³µì‹ ë¬¸ì„œ ê¸°ì¤€)

### 2. í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬
- ìƒì  í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬
- ì†ŒìŠ¤ì½”ë“œì— í•˜ë“œì½”ë”© ê¸ˆì§€
- ìš´ì˜/ê°œë°œ í™˜ê²½ ë¶„ë¦¬

### 3. HTTPS í•„ìˆ˜
- ëª¨ë“  í†µì‹ ì€ HTTPS ì‚¬ìš©
- ReturnURL, CancelURL HTTPS í•„ìˆ˜

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹…

### 1. ê°œë°œ í™˜ê²½ í…ŒìŠ¤íŠ¸
```dart
// ê°œë°œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ëª¨ë“œ
if (AppConstants.isDevelopment) {
  // ë‚˜ì´ìŠ¤í˜ì´ ì—°ë™ ì‹œë®¬ë ˆì´ì…˜
  await Future.delayed(const Duration(seconds: 3));
  // ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
}
```

### 2. ë¡œê¹… ì„¤ì •
```dart
// ê²°ì œ ê´€ë ¨ ë¡œê·¸ í™œì„±í™”
static bool get enableLogging => AppConstants.isDevelopment;
```

### 3. ë””ë²„ê¹… í¬ì¸íŠ¸
- ì„œëª… ìƒì„± ê³¼ì •
- URL íŒŒë¼ë¯¸í„° ê²€ì¦
- ë‚˜ì´ìŠ¤í˜ì´ ì‘ë‹µ íŒŒì‹±
- ìŠ¹ì¸ ìš”ì²­/ì‘ë‹µ

## ğŸš€ ë°°í¬ ê°€ì´ë“œ

### 1. í™˜ê²½ë³€ìˆ˜ ì„¤ì •
```bash
# ìš´ì˜ í™˜ê²½
NICEPAY_MERCHANT_ID=your_merchant_id
NICEPAY_MERCHANT_KEY=your_merchant_key
NICEPAY_RETURN_URL=https://yourdomain.com/api/payment/result
NICEPAY_CANCEL_RETURN_URL=https://yourdomain.com/api/payment/cancel
```

### 2. ë„ë©”ì¸ ë“±ë¡
- ë‚˜ì´ìŠ¤í˜ì´ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë„ë©”ì¸ ë“±ë¡
- ReturnURL, CancelURL ë“±ë¡
- HTTPS ì¸ì¦ì„œ ì„¤ì •

### 3. í…ŒìŠ¤íŠ¸ ê²°ì œ
- ë‚˜ì´ìŠ¤í˜ì´ í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì‚¬ìš©
- ì‹¤ì œ ê²°ì œ ì „ ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸

## ğŸ†˜ ë¬¸ì œ í•´ê²°

### 1. ì¼ë°˜ì ì¸ ì˜¤ë¥˜
- **ì„œëª… ì˜¤ë¥˜**: ì„œëª… ìƒì„± ë°ì´í„° ìˆœì„œ í™•ì¸
- **ë„ë©”ì¸ ì˜¤ë¥˜**: ReturnURL, CancelURL ë“±ë¡ í™•ì¸
- **ê¸ˆì•¡ ì˜¤ë¥˜**: ìµœì†Œ/ìµœëŒ€ ê¸ˆì•¡ ì œí•œ í™•ì¸

### 2. ë””ë²„ê¹… ë°©ë²•
- ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ ë„¤íŠ¸ì›Œí¬ íƒ­ í™•ì¸
- ì„œë²„ ë¡œê·¸ì—ì„œ ë‚˜ì´ìŠ¤í˜ì´ ì‘ë‹µ í™•ì¸
- Flutter ë¡œê·¸ì—ì„œ ê²°ì œ URL í™•ì¸

### 3. ì§€ì› ì—°ë½ì²˜
- ë‚˜ì´ìŠ¤í˜ì´ ê¸°ìˆ  ì§€ì›: 1588-1234
- ê°œë°œì ë¬¸ì„œ: https://docs.nicepay.co.kr

---

ì´ ê°€ì´ë“œë¥¼ ë”°ë¼í•˜ë©´ Flutter + Next.js í™˜ê²½ì—ì„œ ë‚˜ì´ìŠ¤í˜ì´ ê²°ì œ ì‹œìŠ¤í…œì„ ì™„ì „íˆ ì—°ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° ë‹¨ê³„ë¥¼ ì°¨ê·¼ì°¨ê·¼ ë”°ë¼í•˜ì‹œê³ , ë¬¸ì œê°€ ë°œìƒí•˜ë©´ í•´ë‹¹ ì„¹ì…˜ì„ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”.
